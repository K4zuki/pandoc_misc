# USERNAME=
# HOME=

ifeq ($(OS),Windows_NT)
HOME = C:/Users/$(USERNAME)
EXE:=.exe
else
# UNIX common #
EXE =
PANTABLE = pantable
RSVG = rsvg-convert
PYTHON = python3
IMAGINE = pandoc-imagine
CSV2TABLE= csv2table
FONTDIR = "ExternalLocation = /usr/local/share/fonts/"
GPP = /usr/bin/gpp
endif

PANDOC= pandoc
PCROSSREF = pandoc-crossref
PANSTYLES= /var
MISC= $(PANSTYLES)/pandoc_misc
BITFIELD:= bitfield

REFERENCE= $(MISC)/ref.docx

FILTER= $(MISC)/include.py
DOCXPWRTR:= $(MISC)/docxPropertywriter.py
IMAGINEDIR:= pd-images

TEXTEMPLATE := $(MISC)/CJK_xelatex.tex
TEXTEMPLATE_EXTRA := preamble_after.tex
TEXTEMPLATE_COVER := titleGP.tex
TEXTEMPLATE_TAIL := tailnote.tex
# TEXTEMPLATE = $(MISC)/../pandoc-latex-template/eisvogel.latex
TEXFLAGS= --template=$(TEXTEMPLATE) -t latex
# TEXFLAGS += --filter=pandoc-latex-barcode
TEXFLAGS += --pdf-engine=xelatex
TEXFLAGS += --include-in-header=$(TARGETDIR)/$(TEXTEMPLATE_EXTRA)
TEXFLAGS += --include-before-body=$(TARGETDIR)/$(TEXTEMPLATE_COVER)
TEXFLAGS += --include-after-body=$(TARGETDIR)/$(TEXTEMPLATE_TAIL)
TEXFONTFLAGS:= -M documentclass=book
# TEXFONTFLAGS += -M localfontdir=$(FONTDIR)

DATE:= '$(shell date +%b-%d-%Y)'
HASH:= `git rev-parse --short HEAD`
# TEXFLAGS += -V lang=en-us
### pandoc flags
PANFLAGS = --read=markdown+east_asian_line_breaks
PANFLAGS += --filter=pandocker-rmnote
PANFLAGS += --filter=$(PANTABLE)
PANFLAGS += --filter=pandocker-listingtable
PANFLAGS += --filter=pandocker-listingtable-inline
PANFLAGS += --filter=pandocker-bitfield
PANFLAGS += --filter=pandocker-bitfield-inline
PANFLAGS += --filter=pandocker-wavedrom-inline
PANFLAGS += --filter=pandocker-aafigure
PANFLAGS += --filter=pandocker-aafigure-inline
PANFLAGS += --filter=pandocker-blockdiag
PANFLAGS += --filter=pandocker-blockdiag-inline
PANFLAGS += --filter=pandocker-rotateimage
PANFLAGS += --filter=pandocker-rotateimage-inline
PANFLAGS += --filter=$(IMAGINE)
PANFLAGS += --filter=pandocker-tex-landscape
PANFLAGS += --filter=$(PCROSSREF)
PANFLAGS += --toc
PANFLAGS += --listings
PANFLAGS += --top-level-division=chapter
PANFLAGS += --number-sections --highlight-style=kate
PANFLAGS += -M short-hash=$(HASH)
PANFLAGS += -M tables=true
PANFLAGS += -M date=$(DATE)
PANFLAGS += $(MISC)/$(CONFIG)
PANFLAGS += $(MDDIR)/$(CONFIG)
###  for debug  ###
# PANFLAGS += --filter=$(MISC)/panflute/rotate.py
### ### ### ### ###

PANDOCXFFLAGS = --reference-doc=$(REFERENCE)
PANHTMLFLAGS = --self-contained -thtml5
PANHTMLFLAGS += --template=$(MISC)/github.html
PANHTMLFLAGS += -M css=$(MISC)/github_css/github.css

### GPP flags
GPPFLAGS = -H +c "<!--" "-->"
GPPFLAGS += -I$(MDDIR)
GPPFLAGS += -I$(DATADIR)
GPPFLAGS += -I$(TARGETDIR)

###  default directories set; otherwise images/ directory cleaned by make-clean
MDDIR:= markdown
DATADIR:= data
TARGETDIR:= Out
IMAGEDIR:= images
CIDIR:= .circleci
PREFIX:= .
SVGDIR:= svg

### default source and target file names
CONFIG:= config.yaml
INPUT:= TITLE.md
TARGET:= TARGET-$(DATE)-$(HASH)
