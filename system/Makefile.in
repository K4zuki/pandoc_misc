PANDOC := pandoc
PIPBASE := $(shell get-pip-base)
PANSTYLES := $(PIPBASE)/var
MISC := $(PANSTYLES)/pandoc_misc
MISC_SYS := $(MISC)/system
MISC_USER := $(MISC)/user
BITFIELD := bitfield

MDDIR := markdown
DATADIR := data
TARGETDIR := Out
IMAGEDIR := images

DOCXPWRTR := docx-coreprop-writer
IMAGINEDIR := pd-images
LUA_FILTER_BASE := $(PIPBASE)/share/lua/5.3/pandocker

TEXTEMPLATE := $(MISC_SYS)/CJK_xelatex.tex
TEXTEMPLATE_EXTRA := preamble_after.tex
TEXTEMPLATE_COVER := titleGP.tex
TEXTEMPLATE_TAIL := tailnote.tex

SYSTEM_TEXTEMPLATE_EXTRA := $(MISC_SYS)/$(TEXTEMPLATE_EXTRA)
SYSTEM_TEXTEMPLATE_COVER := $(MISC_SYS)/$(TEXTEMPLATE_COVER)
SYSTEM_TEXTEMPLATE_TAIL := $(MISC_SYS)/$(TEXTEMPLATE_TAIL)
TARGET_TEXTEMPLATE_EXTRA := $(TARGETDIR)/$(TEXTEMPLATE_EXTRA)
TARGET_TEXTEMPLATE_COVER := $(TARGETDIR)/$(TEXTEMPLATE_COVER)
TARGET_TEXTEMPLATE_TAIL := $(TARGETDIR)/$(TEXTEMPLATE_TAIL)

DATE := '$(shell date +%d-%b-%Y)'
HASH := '$(shell git rev-parse --short HEAD)'
ENV_VERSION := '$(shell pandocker-version)'

TEXFLAGS := -t latex
TEXFLAGS += --toc
TEXFLAGS += --pdf-engine=xelatex
TEXFLAGS += --include-in-header=$(TARGET_TEXTEMPLATE_EXTRA)
TEXFLAGS += --include-before-body=$(TARGET_TEXTEMPLATE_COVER)
TEXFLAGS += --include-after-body=$(TARGET_TEXTEMPLATE_TAIL)
TEXFLAGS += -M date=$(DATE)

### pandoc flags
PANFLAGS = --read=markdown+east_asian_line_breaks
PANFLAGS += --resource-path=.:$(DATADIR):$(IMAGEDIR):$(MDDIR):$(TARGETDIR)
PANFLAGS += --lua-filter=$(LUA_FILTER_BASE)/removable-note.lua
PANFLAGS += --lua-filter=$(LUA_FILTER_BASE)/tex-landscape.lua
PANFLAGS += --lua-filter=$(LUA_FILTER_BASE)/preprocess.lua
PANFLAGS += --lua-filter=$(LUA_FILTER_BASE)/tex-rowcolors-reset.lua
PANFLAGS += --lua-filter=$(LUA_FILTER_BASE)/docx-unnumberedheadings.lua
PANFLAGS += --lua-filter=$(LUA_FILTER_BASE)/docx-pagebreak-toc.lua
PANFLAGS += --lua-filter=$(LUA_FILTER_BASE)/listingtable.lua
PANFLAGS += --lua-filter=$(LUA_FILTER_BASE)/wavedrom.lua
PANFLAGS += --lua-filter=$(LUA_FILTER_BASE)/csv2table.lua
PANFLAGS += --lua-filter=$(LUA_FILTER_BASE)/table-width.lua
PANFLAGS += --filter=pantable
PANFLAGS += --filter=pandocker-blockdiag-filters
PANFLAGS += --filter=pandoc-svgbob-filter
PANFLAGS += --filter=pandoc-imagine
PANFLAGS += --lua-filter=$(LUA_FILTER_BASE)/svgconvert.lua
PANFLAGS += --filter=pandocker-filters
PANFLAGS += --filter=pandoc-docx-extract-bullet-list
PANFLAGS += --filter=pandoc-crossref
PANFLAGS += --lua-filter=$(LUA_FILTER_BASE)/docx-image-styles.lua
PANFLAGS += --listings
PANFLAGS += --top-level-division=chapter
PANFLAGS += --number-sections --highlight-style=kate
PANFLAGS += -M short-hash=$(HASH)
PANFLAGS += -M tables=true
PANFLAGS += -M envversion=$(ENV_VERSION)
PANFLAGS += $(MDDIR)/$(CONFIG)
PANFLAGS += $(MISC_SYS)/$(CONFIG)

PANDOCXFLAGS := -M linkReferences=true

PANHTMLFLAGS := --self-contained -thtml5
PANHTMLFLAGS += --toc
PANHTMLFLAGS += --template=$(MISC_SYS)/github.html
PANHTMLFLAGS += -M css=$(MISC_SYS)/github_css/github.css
PANHTMLFLAGS += -M date=$(DATE)

PANREVERSEDOCX := -f docx-styles
PANREVERSEDOCX += -t markdown-simple_tables-multiline_tables+grid_tables+pipe_tables
PANREVERSEDOCX += --filter=pantable2csv
PANREVERSEDOCX += --extract-media=$(IMAGEDIR)
PANREVERSEDOCX += --wrap=preserve
PANREVERSEDOCX += --atx-headers

###  default directories set; otherwise images/ directory cleaned by make-clean
CIDIR := .circleci
PREFIX := .
SVGDIR := svg
REFERENCE := $(MISC_SYS)/ref.docx
COREPROPFLAGS := -M created=$(DATE)

### default source and target file names
CONFIG := config.yaml
INPUT := TITLE.md
REVERSE_INPUT := reverse-input.docx
TARGET := TARGET-$(DATE)-$(HASH)
